name: Universal Clash Rules Converter (with SRC-IP-ASN)

on:
  schedule:
    - cron: "0 */6 * * *"  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
  workflow_dispatch:       # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ UI

jobs:
  process-domains:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ª–∏–∑–æ–≤

    steps:
      - name: üöÄ Checkout repository
        uses: actions/checkout@v4

      - name: üìÇ Create output directory
        run: mkdir -p output

      - name: üîç Process domain lists (TXT + YAML + ASN)
        id: process_files
        run: |
          # –ò–°–¢–û–ß–ù–ò–ö–ò: URL -> –∫–æ–Ω—Ñ–∏–≥ (—Ç–∏–ø, –∏–º—è)
          # –§–æ—Ä–º–∞—Ç: "url|type|custom_name"
          sources=(
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/antifilter-download-community.txt"]="antifilter-community"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/antifilter-download.txt"]="antifilter"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/category-ads-all.txt"]="ads-all"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/discord.txt"]="discord"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/google.txt"]="google"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/refilter.txt"]="refilter"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/ru-blocked-all.txt"]="ru-blocked-all"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/ru-blocked.txt"]="ru-blocked"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/win-extra.txt"]="win-extra"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/win-spy.txt"]="win-spy"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/win-update.txt"]="win-update"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/youtube.txt"]="youtube"
            ["https://raw.githubusercontent.com/dartraiden/no-russia-hosts/refs/heads/master/hosts.txt"]="blocked-from-outside"
            ["https://raw.githubusercontent.com/ma3uk/sing-box-rules/refs/heads/main/yaml/akamai.yaml"]="akamai"
          )
          
          file_list=""
          
          for source in "${sources[@]}"; do
            IFS='|' read -r url type custom_name <<< "$source"
            safe_name=$(echo "$custom_name" | 
                        tr '[:upper:]' '[:lower:]' | 
                        sed 's/[^a-z0-9._-]/_/g' |
                        sed 's/__/_/g' |
                        sed 's/^_//;s/_$//')
            
            echo "üì• Processing $url ($type) ‚Üí $safe_name.yaml"
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ–±—Ä–∞–±–æ—Ç–∫–∏
            case "$type" in
              txt|v2ray)
                curl -sfL "$url" | 
                grep -v '^#\|^$\|://' | 
                sed -E '/^[[:space:]]*$/d' |
                awk -v safe_name="$safe_name" -f .github/scripts/process_txt.awk > "output/${safe_name}.yaml"
                ;;
              
              yaml)
                curl -sfL "$url" | 
                awk -v safe_name="$safe_name" -f .github/scripts/process_yaml.awk > "output/${safe_name}.yaml"
                ;;
              
              *)
                echo "‚ùå Unsupported type: $type for $url"
                exit 1
                ;;
            esac
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è
            if [ ! -s "output/${safe_name}.yaml" ]; then
              echo "‚ùå EMPTY FILE: $safe_name.yaml from $url"
              exit 1
            fi
            
            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            domains=$(grep -c "DOMAIN-" "output/${safe_name}.yaml" 2>/dev/null || echo 0)
            ips=$(grep -c "IP-CIDR" "output/${safe_name}.yaml" 2>/dev/null || echo 0)
            regex=$(grep -c "DOMAIN-REGEX" "output/${safe_name}.yaml" 2>/dev/null || echo 0)
            asn=$(grep -c "SRC-IP-ASN" "output/${safe_name}.yaml" 2>/dev/null || echo 0)
            total=$((domains + ips + regex + asn))
            
            echo "‚úÖ Created $safe_name.yaml ($total rules: ${domains}D/${ips}I/${regex}R/${asn}A)"
            
            # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —Ä–µ–ª–∏–∑–∞
            file_size=$(numfmt --to=iec-i --suffix=B --format="%.1f" $(stat -c%s "output/${safe_name}.yaml") 2>/dev/null || echo "unknown size")
            file_list+="- $safe_name.yaml ($file_size, $total rules | ${domains}D/${ips}I/${regex}R/${asn}A | src: $type)\n"
          done
          
          echo "files_list<<EOF" >> $GITHUB_ENV
          echo -e "$file_list" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: üè∑Ô∏è Generate release tag
        id: tag
        run: echo "RELEASE_TAG=v$(date +'%Y%m%d%H')" >> $GITHUB_ENV

      - name: üì§ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "Clash Rules $(date +'%Y-%m-%d %H:%M')"
          body: |
            üåê –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä –ø—Ä–∞–≤–∏–ª –¥–ª—è Clash —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π SRC-IP-ASN
            ‚è∞ –û–±–Ω–æ–≤–ª–µ–Ω–æ: $(date +'%Y-%m-%d %H:%M UTC')
            
            **üì¶ –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
            ${{ env.files_list }}
            
            **‚öôÔ∏è –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –ø—Ä–∞–≤–∏–ª:**
            - **–î–æ–º–µ–Ω—ã:** `DOMAIN`, `DOMAIN-SUFFIX`, `DOMAIN-KEYWORD`, `DOMAIN-REGEX`
            - **IP-–∞–¥—Ä–µ—Å–∞:** `IP-CIDR`, `IP-CIDR6` (—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º no-resolve)
            - **ASN –º–∞—Ä—à—Ä—É—Ç—ã:** `SRC-IP-ASN` (–≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–æ–≤ ASN)
            - **–ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã–µ:** `GEOIP`, `geosite:`
            
            **üîÑ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ASN:**
            - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤: `src-ip-asn:`, `src-asn:`, `asn:`
            - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è ASN (–¥–∏–∞–ø–∞–∑–æ–Ω 1-4294967295)
            - –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç Clash: `SRC-IP-ASN,12345`
            - –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö ASN –Ω–æ–º–µ—Ä–æ–≤
            
            **üí° –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ASN –ø—Ä–∞–≤–∏–ª –≤ Clash:**
            ```yaml
            rules:
              - SRC-IP-ASN,12345,DIRECT  # –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è ASN 12345
              - SRC-IP-ASN,67890,PROXY   # –ü—Ä–æ–∫—Å–∏ –¥–ª—è ASN 67890
            ```
          files: |
            output/*.yaml
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üóëÔ∏è Cleanup
        if: always()
        run: rm -rf output/

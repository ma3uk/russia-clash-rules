name: Convert Domain Lists to Clash YAML (Individual Files)

on:
  schedule:
    - cron: "0 */6 * * *"  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
  workflow_dispatch:       # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ UI

jobs:
  process-domains:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ª–∏–∑–æ–≤

    steps:
      - name: üöÄ Checkout repository
        uses: actions/checkout@v4

      - name: üìÇ Create output directory
        run: mkdir -p output

      - name: üîç Process domain lists
        run: |
          urls=(
            "https://github.com/runetfreedom/russia-blocked-geosite/releases/download/202511231512/antifilter-download-community.txt"
            "https://github.com/runetfreedom/russia-blocked-geosite/releases/download/202511231512/antifilter-download.txt"
          )
          
          for url in "${urls[@]}"; do
            filename=$(basename "$url" | sed 's/\.txt$//' | tr '/' '_')
            echo "üì• Processing $url ‚Üí ${filename}.yaml"
            
            curl -sfL "$url" | 
            grep -v '^#\|^$\|://' |  # –£–¥–∞–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ URL
            sed -E '/^[[:space:]]*$/d' |  # –£–¥–∞–ª—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
            awk 'BEGIN {print "payload:"} {print "  - DOMAIN-SUFFIX," $0}' > "output/${filename}.yaml"
            
            if [ ! -s "output/${filename}.yaml" ]; then
              echo "‚ùå Empty file generated for $url"
              exit 1
            fi
            echo "‚úÖ Created output/${filename}.yaml ($(wc -l < "output/${filename}.yaml") lines)"
          done

      - name: üè∑Ô∏è Generate release tag
        id: tag
        run: echo "RELEASE_TAG=v$(date +'%Y%m%d%H')" >> $GITHUB_ENV

      - name: üì§ Create GitHub Release with Individual Files
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "Clash Rules Update $(date +'%Y-%m-%d %H:%M')"
          body: |
            –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ YAML-–ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è Clash.
            –û–±–Ω–æ–≤–ª–µ–Ω–æ: $(date +'%Y-%m-%d %H:%M UTC')
            
            **–°–ø–∏—Å–∫–∏ –≤–∫–ª—é—á–∞—é—Ç:**
            - antifilter-download-community.yaml
            - antifilter-download.yaml
          files: |
            output/*.yaml
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üóëÔ∏è Cleanup (optional)
        if: always()
        run: rm -rf output/

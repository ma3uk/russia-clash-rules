name: Convert Domain Lists to Clash YAML (V2Ray Support)

on:
  schedule:
    - cron: "0 */6 * * *"  # Every 6 hours
  workflow_dispatch:       # Manual trigger

jobs:
  process-domains:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # For creating releases

    steps:
      - name: üöÄ Checkout repository
        uses: actions/checkout@v4

      - name: üìÇ Create output directory
        run: mkdir -p output

      - name: üîç Process domain lists with V2Ray prefix conversion
        id: process_files
        run: |
          # SOURCE ARRAY: URL -> Desired filename
          declare -A sources=(
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/antifilter-download-community.txt"]="antifilter-community"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/antifilter-download.txt"]="antifilter"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/category-ads-all.txt"]="ads-all"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/discord.txt"]="discord"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/google.txt"]="google"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/refilter.txt"]="refilter"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/ru-blocked-all.txt"]="ru-blocked-all"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/ru-blocked.txt"]="ru-blocked"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/win-extra.txt"]="win-extra"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/win-spy.txt"]="win-spy"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/win-update.txt"]="win-update"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/youtube.txt"]="youtube"
            ["https://raw.githubusercontent.com/dartraiden/no-russia-hosts/refs/heads/master/hosts.txt"]="blocked-from-outside"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/akamai.txt"]="akamai"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/amazon.txt"]="amazon"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/autodesk.txt"]="autodesk"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/azure.txt"]="azure"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/cloudflare.txt"]="cloudflare"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/gemini.txt"]="gemini"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/hetzner.txt"]="hetzner"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/intel.txt"]="intel"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/riot-games.txt"]="riot-games"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/roscomandzor-iplist.txt"]="roscomandzor-iplist"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/telegram.txt"]="telegram"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/twitter.txt"]="twitter"
          )
          
          file_list=""
          
          for url in "${!sources[@]}"; do
            custom_name="${sources[$url]}"
            safe_name=$(echo "$custom_name" | 
                        tr '[:upper:]' '[:lower:]' | 
                        sed 's/[^a-z0-9._-]/_/g' |
                        sed 's/__/_/g' |
                        sed 's/^_//;s/_$//')
            
            echo "üì• Processing $url ‚Üí $safe_name.yaml"
            
            # Download and convert with V2Ray prefix and IP support
            curl -sfL "$url" | 
            grep -v '^#\|^$\|://' |          # Remove comments and empty lines
            sed -E '/^[[:space:]]*$/d' |     # Remove remaining empty lines
            awk -v name="$safe_name" '
              BEGIN { print "payload:" }
              {
                gsub(/^[ \t]+|[ \t]+$/, "", $0);  # Trim whitespace
                if ($0 == "") next;
                
                # Handle V2Ray prefixes
                if ($0 ~ /^domain:/) {
                  domain = substr($0, 8);
                  processDomain(domain);
                }
                else if ($0 ~ /^full:/) {
                  domain = substr($0, 6);
                  print "  - DOMAIN," domain;
                }
                else if ($0 ~ /^regexp:/) {
                  regex = substr($0, 9);
                  gsub(/\\/, "\\\\", regex);  # Escape backslashes for YAML
                  print "  - DOMAIN-REGEX," regex;
                }
                else if ($0 ~ /^geosite:/) {
                  next;  # Skip unsupported geosite rules
                }
                else {
                  # Auto-detect IP addresses and domains
                  if (isIPv4($0)) {
                    if ($0 !~ /\//) $0 = $0 "/32";
                    print "  - IP-CIDR," $0;
                  }
                  else if (isIPv6($0)) {
                    if ($0 !~ /\//) $0 = $0 "/128";
                    print "  - IP-CIDR6," $0;
                  }
                  else {
                    processDomain($0);
                  }
                }
              }
              
              function isIPv4(str) {
                if (str ~ /^([0-9]{1,3}[.]){3}[0-9]{1,3}(\/[0-9]{1,2})?$/) {
                  split(str, parts, /\//);
                  ip = parts[1];
                  split(ip, octets, ".");
                  if (length(octets) != 4) return 0;
                  for (i=1; i<=4; i++) {
                    if (octets[i] !~ /^[0-9]+$/ || octets[i] < 0 || octets[i] > 255) 
                      return 0;
                  }
                  if (length(parts) == 2) {
                    prefix = parts[2];
                    if (prefix !~ /^[0-9]+$/ || prefix < 0 || prefix > 32)
                      return 0;
                  }
                  return 1;
                }
                return 0;
              }
              
              function isIPv6(str) {
                if (str ~ /:/ && str !~ /\./ && str ~ /^[0-9a-fA-F:\/]+$/) {
                  split(str, parts, /\//);
                  ip = parts[1];
                  
                  # Basic IPv6 validation
                  if (ip == "" || ip ~ /::$/ || ip ~ /^:::/ || ip ~ /:::/) 
                    return 0;
                  
                  # Count colons (valid IPv6 has 2-7 colons in uncompressed form)
                  colonCount = gsub(/:/, "&", ip);
                  if (colonCount < 2 || colonCount > 7) 
                    return 0;
                  
                  # Validate prefix length if present
                  if (length(parts) == 2) {
                    prefix = parts[2];
                    if (prefix !~ /^[0-9]+$/ || prefix < 0 || prefix > 128)
                      return 0;
                  }
                  return 1;
                }
                return 0;
              }
              
              function processDomain(domain) {
                if (domain ~ /\*/) {
                  if (domain ~ /^\*/) {
                    gsub(/^\*\./, "", domain);
                    print "  - DOMAIN-SUFFIX," domain;
                  } else if (domain ~ /\*$/) {
                    gsub(/\*$/, "", domain);
                    print "  - DOMAIN-KEYWORD," domain;
                  } else {
                    print "  - DOMAIN," domain;
                  }
                } else {
                  print "  - DOMAIN-SUFFIX," domain;
                }
              }
            ' > "output/${safe_name}.yaml"
            
            # Validation
            if [ ! -s "output/${safe_name}.yaml" ]; then
              echo "‚ùå EMPTY FILE: $safe_name.yaml from $url"
              exit 1
            fi
            
            # Count ALL rule types (domains + IPs)
            rules_count=$(grep -c '^  - ' "output/${safe_name}.yaml" || true)
            echo "‚úÖ Created $safe_name.yaml ($rules_count rules)"
            
            # Prepare release description
            file_size=$(numfmt --to=iec-i --suffix=B --format="%.1f" $(stat -c%s "output/${safe_name}.yaml") 2>/dev/null || echo "unknown size")
            file_list+="- $safe_name.yaml ($file_size, $rules_count rules)\n"
          done
          
          # Save file list for release step
          echo "files_list<<EOF" >> $GITHUB_ENV
          echo -e "$file_list" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: üè∑Ô∏è Generate release tag
        id: tag
        run: echo "RELEASE_TAG=v$(date +'%Y%m%d%H%M')" >> $GITHUB_ENV

      - name: üì§ Create GitHub Release with Individual Files
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "Clash Rules"
          body: |
            
            **Available files:**
            ${{ env.files_list }}
            
          files: |
            output/*.yaml
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üóëÔ∏è Cleanup
        if: always()
        run: rm -rf output/

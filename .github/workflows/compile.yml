name: Convert Domain Lists to Clash YAML (IP + V2Ray + Wildcard Support)

on:
  schedule:
    - cron: "0 */6 * * *"  # Every 6 hours
  workflow_dispatch:       # Manual trigger

jobs:
  process-domains:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # For creating releases

    steps:
      - name: üöÄ Checkout repository
        uses: actions/checkout@v4

      - name: üìÇ Create output directory
        run: mkdir -p output

      - name: üîç Process domain lists with proper YAML formatting
        id: process_files
        run: |
          # SOURCE ARRAY: URL -> Desired filename
          declare -A sources=(
            ["https://community.antifilter.download/list/domains.lst"]="antifilter-community"
            ["https://community.antifilter.download/list/community.lst"]="antifilter-community-ip"
            ["https://antifilter.download/list/allyouneed.lst"]="antifilter"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/category-ads-all.txt"]="ads-all"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/discord.txt"]="discord"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/google.txt"]="google"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/refilter.txt"]="refilter"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/ru-blocked-all.txt"]="ru-blocked-all"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/ru-blocked.txt"]="ru-blocked"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/win-extra.txt"]="win-extra"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/win-spy.txt"]="win-spy"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/win-update.txt"]="win-update"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/youtube.txt"]="youtube"
            ["https://raw.githubusercontent.com/dartraiden/no-russia-hosts/refs/heads/master/hosts.txt"]="blocked-from-outside"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/akamai.txt"]="akamai"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/amazon.txt"]="amazon"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/autodesk.txt"]="autodesk"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/azure.txt"]="azure"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/cloudflare.txt"]="cloudflare"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/gemini.txt"]="gemini"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/hetzner.txt"]="hetzner"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/intel.txt"]="intel"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/riot-games.txt"]="riot-games"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/roscomandzor-iplist.txt"]="roscomandzor-iplist"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/telegram.txt"]="telegram"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/twitter.txt"]="twitter"
          )
          
          file_list=""
          
          for url in "${!sources[@]}"; do
            custom_name="${sources[$url]}"
            safe_name=$(echo "$custom_name" | 
                        tr '[:upper:]' '[:lower:]' | 
                        sed 's/[^a-z0-9._-]/_/g' |
                        sed 's/__/_/g' |
                        sed 's/^_//;s/_$//')
            
            echo "üì• Processing $url ‚Üí $safe_name.yaml"
            
            # Download and convert with proper YAML formatting
            curl -sfL "$url" | 
            tr -d '\r' |                      # Remove Windows carriage returns
            sed -E 's/#.*$//g' |              # Remove ALL comments from lines
            sed -E 's/^[ \t]*//; s/[ \t]*$//' | # Trim leading/trailing whitespace
            grep -vE '^$|://' |               # Remove empty lines and URLs
            awk -v name="$safe_name" '
              BEGIN { 
                # CORRECT YAML FORMATTING: 2 SPACES FOR INDENTATION
                print "payload:"
              }
              
              {
                # Final whitespace cleanup
                gsub(/^[ \t]+|[ \t]+$/, "", $0);
                if ($0 == "") next;
                
                # 1. IPv4/CIDR DETECTION (HIGHEST PRIORITY)
                if ($0 ~ /^([0-9]{1,3}\.){3}[0-9]{1,3}(\/[0-9]{1,2})?$/) {
                  split($0, parts, "/");
                  ip = parts[1];
                  
                  # Validate IPv4 octets
                  split(ip, octets, ".");
                  valid = 1;
                  if (length(octets) != 4) valid = 0;
                  else {
                    for (i=1; i<=4; i++) {
                      if (octets[i] !~ /^[0-9]+$/ || octets[i] < 0 || octets[i] > 255) {
                        valid = 0;
                        break;
                      }
                    }
                  }
                  
                  if (valid) {
                    if (length(parts) == 2) {
                      prefix = parts[2] + 0;  # Force numeric conversion
                      if (prefix >= 0 && prefix <= 32) {
                        # CORRECT YAML: 2 spaces indentation
                        print "  - IP-CIDR," $0;
                        next;
                      }
                    } else {
                        # CORRECT YAML: 2 spaces indentation
                        print "  - IP-CIDR," ip "/32";
                        next;
                    }
                  }
                }
                
                # 2. IPv6/CIDR DETECTION
                else if ($0 ~ /^[0-9a-fA-F:]+(\/[0-9]{1,3})?$/) {
                  split($0, parts, "/");
                  ip = parts[1];
                  
                  # Basic IPv6 validation
                  if (ip ~ /:/ && ip !~ /\.\./ && ip != "::" && ip != ":" && ip != "") {
                    colons = gsub(/:/, "", ip);  # Count colons by removing them
                    if (colons >= 1 && colons <= 7) {  # Valid colon count for IPv6
                      if (length(parts) == 2) {
                        prefix = parts[2] + 0;  # Force numeric conversion
                        if (prefix >= 0 && prefix <= 128) {
                          # CORRECT YAML: 2 spaces indentation
                          print "  - IP-CIDR6," $0;
                          next;
                        }
                      } else {
                          # CORRECT YAML: 2 spaces indentation
                          print "  - IP-CIDR6," ip "/128";
                          next;
                      }
                    }
                  }
                }
                
                # 3. V2Ray prefix handling
                if ($0 ~ /^domain:/) {
                  domain = substr($0, 8);
                  gsub(/^[ \t]+|[ \t]+$/, "", domain);
                  if (domain ~ /^\*/) {
                    gsub(/^\*\./, "", domain);
                    # CORRECT YAML: 2 spaces indentation
                    print "  - DOMAIN-SUFFIX," domain;
                  } else if (domain ~ /\*$/) {
                    gsub(/\*$/, "", domain);
                    # CORRECT YAML: 2 spaces indentation
                    print "  - DOMAIN-KEYWORD," domain;
                  } else {
                    # CORRECT YAML: 2 spaces indentation
                    print "  - DOMAIN," domain;
                  }
                  next;
                }
                else if ($0 ~ /^full:/) {
                  domain = substr($0, 6);
                  gsub(/^[ \t]+|[ \t]+$/, "", domain);
                  # CORRECT YAML: 2 spaces indentation
                  print "  - DOMAIN," domain;
                  next;
                }
                else if ($0 ~ /^regexp:/) {
                  regex = substr($0, 9);
                  gsub(/^[ \t]+|[ \t]+$/, "", regex);
                  
                  # Convert V2Ray regex to Clash compatible format
                  if (canConvertToWildcard(regex)) {
                    wildcard = convertToWildcard(regex);
                    # CORRECT YAML: 2 spaces indentation
                    print "  - DOMAIN-WILDCARD," wildcard;
                  } else {
                    gsub(/\\/, "\\\\", regex);  # Escape backslashes for YAML
                    # CORRECT YAML: 2 spaces indentation
                    print "  - DOMAIN-REGEX," regex;
                  }
                  next;
                }
                else if ($0 ~ /^geosite:/) {
                  next;  # Skip unsupported geosite rules
                }
                
                # 4. AUTOMATIC WILDCARD DETECTION
                if ($0 ~ /\\\.|\\[a-zA-Z]|^[\^]|\$$|\[[^\]]+\]|\{[0-9,]+\}|\|/ || 
                    ($0 ~ /[\+\*\?]/ && ($0 ~ /\.[a-z]{2,}$/ || $0 ~ /\.[a-z]{2,}\$$/))) {
                  
                  if (canConvertToWildcard($0)) {
                    wildcard = convertToWildcard($0);
                    # CORRECT YAML: 2 spaces indentation
                    print "  - DOMAIN-WILDCARD," wildcard;
                    next;
                  }
                  
                  # Special handling for common regex patterns
                  if ($0 ~ /\\\.com$/) {
                    gsub(/\\\.com$/, "\\\\\\.com", $0);
                  }
                  if ($0 ~ /\\\.net$/) {
                    gsub(/\\\.net$/, "\\\\\\.net", $0);
                  }
                  
                  # Escape backslashes for YAML compatibility
                  gsub(/\\/, "\\\\", $0);
                  
                  # Add ^ and $ anchors if missing
                  if ($0 !~ /^\^/ && $0 !~ /\$$/) {
                    $0 = "^" $0 "$";
                  }
                  
                  # CORRECT YAML: 2 spaces indentation
                  print "  - DOMAIN-REGEX," $0;
                  next;
                }
                
                # 5. Final domain processing
                if ($0 ~ /^\*/) {
                  gsub(/^\*\./, "", $0);
                  # CORRECT YAML: 2 spaces indentation
                  print "  - DOMAIN-SUFFIX," $0;
                }
                else if ($0 ~ /\*$/) {
                  gsub(/\*$/, "", $0);
                  # CORRECT YAML: 2 spaces indentation
                  print "  - DOMAIN-KEYWORD," $0;
                }
                else {
                  # CORRECT YAML: 2 spaces indentation
                  print "  - DOMAIN-SUFFIX," $0;
                }
              }
              
              # Function to check if regex can be converted to wildcard
              function canConvertToWildcard(pattern) {
                gsub(/^[ \t]+|[ \t]+$/, "", pattern);
                gsub(/^\^|\$$/, "", pattern);
                
                if (pattern ~ /^\\\*\./ && pattern !~ /[\^\$\[\]\{\}\+\|\?]/) {
                  return 1;
                }
                else if (pattern ~ /^\*\./ && pattern !~ /[\^\$\[\]\{\}\+\|\?]/) {
                  return 1;
                }
                else if (pattern ~ /^\.\*\\\./ && pattern !~ /[\^\$\[\]\{\}\+\|\?]/) {
                  if (pattern !~ /\\\.[a-z]{2,}$/) {
                    return 0;
                  }
                  return 1;
                }
                return 0;
              }
              
              # Function to convert regex to wildcard format
              function convertToWildcard(pattern,    result) {
                gsub(/^[ \t]+|[ \t]+$/, "", pattern);
                gsub(/^\^|\$$/, "", pattern);
                
                if (pattern ~ /^\\\*\./) {
                  gsub(/^\\\*\./, "*.", pattern);
                  gsub(/\\\./, ".", pattern);
                  result = pattern;
                }
                else if (pattern ~ /^\*\./) {
                  gsub(/\\\./, ".", pattern);
                  result = pattern;
                }
                else if (pattern ~ /^\.\*\\\./) {
                  gsub(/^\.\*\\\./, "*.", pattern);
                  gsub(/\\\./, ".", pattern);
                  result = pattern;
                }
                else {
                  gsub(/\\\./, ".", pattern);
                  result = "*." pattern;
                }
                
                if (result !~ /^\*\./) {
                  result = "*." result;
                }
                
                return result;
              }
            ' > "output/${safe_name}.yaml"
            
            # Validation
            if [ ! -s "output/${safe_name}.yaml" ]; then
              echo "‚ùå EMPTY FILE: $safe_name.yaml from $url"
              exit 1
            fi
            
            rules_count=$(grep -c '^  - ' "output/${safe_name}.yaml" || echo "0")
            echo "‚úÖ Created $safe_name.yaml ($rules_count rules)"
            
            # Prepare release description
            file_size=$(numfmt --to=iec-i --suffix=B --format="%.1f" $(stat -c%s "output/${safe_name}.yaml") 2>/dev/null || echo "unknown size")
            file_list+="- $safe_name.yaml ($file_size, $rules_count rules)\n"
          done
          
          # Save file list for release step
          echo "files_list<<EOF" >> $GITHUB_ENV
          echo -e "$file_list" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: üè∑Ô∏è Generate release tag
        id: tag
        run: echo "RELEASE_TAG=v$(date +'%Y%m%d%H%M%S')" >> $GITHUB_ENV

      - name: üì§ Create GitHub Release with Individual Files
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "Clash Rules"
          body: |
            
            **Available files with proper YAML formatting:**
            ${{ env.files_list }}
            
          files: |
            output/*.yaml
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üóëÔ∏è Cleanup
        if: always()
        run: rm -rf output/

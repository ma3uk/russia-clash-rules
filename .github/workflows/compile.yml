name: Convert Domain Lists to Clash YAML (V2Ray Support)

on:
  schedule:
    - cron: "0 */6 * * *"  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
  workflow_dispatch:       # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ UI

jobs:
  process-domains:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ª–∏–∑–æ–≤

    steps:
      - name: üöÄ Checkout repository
        uses: actions/checkout@v4

      - name: üìÇ Create output directory
        run: mkdir -p output

      - name: üîç Process domain lists with V2Ray prefix conversion
        id: process_files
        run: |
          # –ú–ê–°–°–ò–í –ò–°–¢–û–ß–ù–ò–ö–û–í: URL -> –ñ–µ–ª–∞–µ–º–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
          declare -A sources=(
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/antifilter-download-community.txt"]="antifilter-community"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/antifilter-download.txt"]="antifilter"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/category-ads-all.txt"]="ads-all"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/discord.txt"]="discord"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/google.txt"]="google"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/refilter.txt"]="refilter"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/ru-blocked-all.txt"]="ru-blocked-all"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/ru-blocked.txt"]="ru-blocked"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/win-extra.txt"]="win-extra"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/win-spy.txt"]="win-spy"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/win-update.txt"]="win-update"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/youtube.txt"]="youtube"
            ["https://raw.githubusercontent.com/dartraiden/no-russia-hosts/refs/heads/master/hosts.txt"]="blocked-from-outside"
          )
          
          file_list=""
          
          for url in "${!sources[@]}"; do
            custom_name="${sources[$url]}"
            safe_name=$(echo "$custom_name" | 
                        tr '[:upper:]' '[:lower:]' | 
                        sed 's/[^a-z0-9._-]/_/g' |
                        sed 's/__/_/g' |
                        sed 's/^_//;s/_$//')
            
            echo "üì• Processing $url ‚Üí $safe_name.yaml"
            
            # –°–∫–∞—á–∏–≤–∞–µ–º –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π V2Ray –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤
            curl -sfL "$url" | 
            grep -v '^#\|^$\|://' |          # –£–¥–∞–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
            sed -E '/^[[:space:]]*$/d' |     # –£–¥–∞–ª—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
            awk -v name="$safe_name" '
              BEGIN { print "payload:" }
              {
                # –£–¥–∞–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ/–∫–æ–Ω—Ü–µ
                gsub(/^[ \t]+|[ \t]+$/, "", $0);
                
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ V2Ray –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤
                if ($0 ~ /^domain:/) {
                  domain = substr($0, 8);  # –£–±–∏—Ä–∞–µ–º "domain:"
                  # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–ª–∏—á–∏—è —Ç–æ—á–µ–∫ –∏ –∑–≤—ë–∑–¥–æ—á–µ–∫
                  if (domain ~ /\*/) {
                    # –ï—Å–ª–∏ –µ—Å—Ç—å –∑–≤—ë–∑–¥–æ—á–∫–∞ - —ç—Ç–æ DOMAIN-KEYWORD –∏–ª–∏ DOMAIN-SUFFIX
                    if (domain ~ /^\*/) {
                      # *.example.com ‚Üí DOMAIN-SUFFIX,example.com
                      gsub(/^\*\./, "", domain);
                      print "  - DOMAIN-SUFFIX," domain;
                    } else if (domain ~ /\*$/) {
                      # example* ‚Üí DOMAIN-KEYWORD,example
                      gsub(/\*$/, "", domain);
                      print "  - DOMAIN-KEYWORD," domain;
                    } else {
                      # example*.com ‚Üí DOMAIN,example*.com (—Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π)
                      print "  - DOMAIN," domain;
                    }
                  } else {
                    # example.com ‚Üí DOMAIN-SUFFIX,example.com
                    print "  - DOMAIN-SUFFIX," domain;
                  }
                }
                else if ($0 ~ /^full:/) {
                  # full:example.com ‚Üí DOMAIN,example.com
                  domain = substr($0, 6);
                  print "  - DOMAIN," domain;
                }
                else if ($0 ~ /^regexp:/) {
                  # regexp:^example\.com$ ‚Üí DOMAIN-REGEX,^example\.com$
                  regex = substr($0, 9);
                  # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω—ã–µ —Å–ª–µ—à–∏ –¥–ª—è YAML (–¥–≤–æ–π–Ω–æ–π —Å–ª–µ—à)
                  gsub(/\\/, "\\\\", regex);
                  print "  - DOMAIN-REGEX," regex;
                }
                else if ($0 ~ /^geosite:/) {
                  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º geosite –ø—Ä–∞–≤–∏–ª–∞ (–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤ Clash –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞)
                  next;
                }
                else {
                  # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –¥–æ–º–µ–Ω—ã –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞
                  if ($0 ~ /\*/) {
                    # –û–±—Ä–∞–±–æ—Ç–∫–∞ wildcard –¥–æ–º–µ–Ω–æ–≤
                    if ($0 ~ /^\*/) {
                      gsub(/^\*\./, "", $0);
                      print "  - DOMAIN-SUFFIX," $0;
                    } else if ($0 ~ /\*$/) {
                      gsub(/\*$/, "", $0);
                      print "  - DOMAIN-KEYWORD," $0;
                    } else {
                      print "  - DOMAIN," $0;
                    }
                  } else {
                    # –û–±—ã—á–Ω—ã–π –¥–æ–º–µ–Ω
                    print "  - DOMAIN-SUFFIX," $0;
                  }
                }
              }
            ' > "output/${safe_name}.yaml"
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è
            if [ ! -s "output/${safe_name}.yaml" ]; then
              echo "‚ùå EMPTY FILE: $safe_name.yaml from $url"
              exit 1
            fi
            
            domains_count=$(grep -c "DOMAIN-" "output/${safe_name}.yaml" || true)
            echo "‚úÖ Created $safe_name.yaml ($domains_count rules)"
            
            # –°–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è —Ä–µ–ª–∏–∑–∞
            file_size=$(numfmt --to=iec-i --suffix=B --format="%.1f" $(stat -c%s "output/${safe_name}.yaml") 2>/dev/null || echo "unknown size")
            file_list+="- $safe_name.yaml ($file_size, $domains_count rules)\n"
          done
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è —à–∞–≥–∞ —Ä–µ–ª–∏–∑–∞
          echo "files_list<<EOF" >> $GITHUB_ENV
          echo -e "$file_list" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: üè∑Ô∏è Generate release tag
        id: tag
        run: echo "RELEASE_TAG=v$(date +'%Y%m%d%H')" >> $GITHUB_ENV

      - name: üì§ Create GitHub Release with Individual Files
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "Clash Rules $(date +'%Y-%m-%d %H:%M')"
          body: |
            ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è Clash —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π V2Ray-—Ñ–æ—Ä–º–∞—Ç–æ–≤.
            ‚è∞ –û–±–Ω–æ–≤–ª–µ–Ω–æ: $(date +'%Y-%m-%d %H:%M UTC')
            
            **–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã:**
            ${{ env.files_list }}
            
            üîß **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø—Ä–µ—Ñ–∏–∫—Å—ã V2Ray:**
            - `domain:` ‚Üí `DOMAIN-SUFFIX` (–∏–ª–∏ `DOMAIN-KEYWORD` –¥–ª—è wildcard)
            - `full:` ‚Üí `DOMAIN`
            - `regexp:` ‚Üí `DOMAIN-REGEX` (—Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ–±—Ä–∞—Ç–Ω—ã—Ö —Å–ª–µ—à–µ–π)
            - `geosite:` ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è (–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ Clash)
            
            üí° **–ü—Ä–∏–º–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ Clash:**
            ```yaml
            rule-providers:
              anti-ads:
                type: http
                url: "https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_TAG }}/anti-ads.yaml"
                path: ./ruleset/anti-ads.yaml
                interval: 21600  # 6 —á–∞—Å–æ–≤
            ```
          files: |
            output/*.yaml
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üóëÔ∏è Cleanup
        if: always()
        run: rm -rf output/

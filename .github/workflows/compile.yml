name: Universal Clash Rules Converter

on:
  schedule:
    - cron: "0 */6 * * *"  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
  workflow_dispatch:       # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ UI

jobs:
  process-domains:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ª–∏–∑–æ–≤

    steps:
      - name: üöÄ Checkout repository
        uses: actions/checkout@v4

      - name: üìÇ Create output directory
        run: mkdir -p output

      - name: üîç Process domain lists (TXT + YAML + ASN)
        id: process_files
        run: |
          # –ò–°–¢–û–ß–ù–ò–ö–ò: URL -> –∫–æ–Ω—Ñ–∏–≥ (—Ç–∏–ø, –∏–º—è)
          # –§–æ—Ä–º–∞—Ç: "url|type|custom_name"
          sources=(
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/antifilter-download-community.txt"]="antifilter-community"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/antifilter-download.txt"]="antifilter"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/category-ads-all.txt"]="ads-all"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/discord.txt"]="discord"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/google.txt"]="google"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/refilter.txt"]="refilter"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/ru-blocked-all.txt"]="ru-blocked-all"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/ru-blocked.txt"]="ru-blocked"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/win-extra.txt"]="win-extra"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/win-spy.txt"]="win-spy"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/win-update.txt"]="win-update"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/youtube.txt"]="youtube"
            ["https://raw.githubusercontent.com/dartraiden/no-russia-hosts/refs/heads/master/hosts.txt"]="blocked-from-outside"
          )
          
          file_list=""
          
          for source in "${sources[@]}"; do
            IFS='|' read -r url type custom_name <<< "$source"
            safe_name=$(echo "$custom_name" | 
                        tr '[:upper:]' '[:lower:]' | 
                        sed 's/[^a-z0-9._-]/_/g' |
                        sed 's/__/_/g' |
                        sed 's/^_//;s/_$//')
            
            echo "üì• Processing $url ($type) ‚Üí $safe_name.yaml"
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ–±—Ä–∞–±–æ—Ç–∫–∏
            case "$type" in
              txt|v2ray)
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ TXT/V2Ray —Ñ–∞–π–ª–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π ASN
                curl -sfL "$url" | 
                grep -v '^#\|^$\|://' | 
                sed -E '/^[[:space:]]*$/d' |
                awk -v safe_name="$safe_name" -f /dev/stdin <<'EOF_AWK'
                  BEGIN { 
                    print "payload:" 
                    domain_count = 0
                    ip_count = 0
                    regex_count = 0
                    asn_count = 0
                  }
                  function is_valid_asn(asn) {
                    if (asn ~ /^[0-9]+$/) {
                      num = asn + 0;
                      return (num >= 1 && num <= 4294967295);
                    }
                    return 0;
                  }
                  function is_ipv4(addr) {
                    if (addr ~ /^([0-9]{1,3}\\.){3}[0-9]{1,3}(\/[0-9]{1,2})?$/) {
                      split(addr, parts, "/"); if (parts[2] == "") parts[2] = 32;
                      if (parts[2] < 0 || parts[2] > 32) return 0;
                      split(parts[1], octets, "."); if (length(octets) != 4) return 0;
                      for (i=1; i<=4; i++) if (octets[i] < 0 || octets[i] > 255) return 0;
                      return 1;
                    }
                    return 0;
                  }
                  function is_ipv6(addr) {
                    if (addr ~ /^([0-9a-fA-F:]+)(\/[0-9]{1,3})?$/) {
                      split(addr, parts, "/"); if (parts[2] == "") parts[2] = 128;
                      if (parts[2] < 0 || parts[2] > 128) return 0;
                      return 1;
                    }
                    return 0;
                  }
                  {
                    gsub(/^[ \t]+|[ \t]+$/, "", $0);
                    if ($0 ~ /^geosite:/) next;
                    
                    # –û–±—Ä–∞–±–æ—Ç–∫–∞ ASN –ø—Ä–∞–≤–∏–ª
                    if ($0 ~ /^(src-ip-asn:|src-asn:|asn:)/) {
                      asn = substr($0, index($0, ":") + 1);
                      gsub(/^[ \t]+|[ \t]+$/, "", asn);
                      if (is_valid_asn(asn)) {
                        print "  - SRC-IP-ASN," asn;
                        asn_count++;
                      }
                      next;
                    }
                    
                    # –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –¥–æ–º–µ–Ω–æ–≤ –∏ IP
                    if ($0 ~ /^domain:/) {
                      domain = substr($0, 8); gsub(/^[ \t]+|[ \t]+$/, "", domain);
                      if (domain ~ /\*/) {
                        if (domain ~ /^\*/) { gsub(/^\*\./, "", domain); print "  - DOMAIN-SUFFIX," domain; domain_count++ }
                        else if (domain ~ /\*$/) { gsub(/\*$/, "", domain); print "  - DOMAIN-KEYWORD," domain; domain_count++ }
                        else { print "  - DOMAIN," domain; domain_count++ }
                      } else { print "  - DOMAIN-SUFFIX," domain; domain_count++ }
                    }
                    else if ($0 ~ /^full:/) {
                      domain = substr($0, 6); gsub(/^[ \t]+|[ \t]+$/, "", domain);
                      print "  - DOMAIN," domain; domain_count++;
                    }
                    else if ($0 ~ /^regexp:/) {
                      regex = substr($0, 9); gsub(/^[ \t]+|[ \t]+$/, "", regex);
                      gsub(/\\/, "\\\\", regex);
                      print "  - DOMAIN-REGEX," regex; regex_count++;
                    }
                    else if ($0 ~ /^ipcidr:/) {
                      ip_range = substr($0, 9); gsub(/^[ \t]+|[ \t]+$/, "", ip_range);
                      if (is_ipv4(ip_range)) {
                        if (ip_range !~ /\//) ip_range = ip_range "/32";
                        print "  - IP-CIDR," ip_range ",no-resolve"; ip_count++;
                      }
                      else if (is_ipv6(ip_range)) {
                        if (ip_range !~ /\//) ip_range = ip_range "/128";
                        print "  - IP-CIDR6," ip_range ",no-resolve"; ip_count++;
                      }
                    }
                    else {
                      if (is_ipv4($0)) {
                        ip = $0; if (ip !~ /\//) ip = ip "/32";
                        print "  - IP-CIDR," ip ",no-resolve"; ip_count++;
                      }
                      else if (is_ipv6($0)) {
                        ip = $0; if (ip !~ /\//) ip = ip "/128";
                        print "  - IP-CIDR6," ip ",no-resolve"; ip_count++;
                      }
                      else if ($0 ~ /\*/) {
                        if ($0 ~ /^\*/) { gsub(/^\*\./, "", $0); print "  - DOMAIN-SUFFIX," $0; domain_count++ }
                        else if ($0 ~ /\*$/) { gsub(/\*$/, "", $0); print "  - DOMAIN-KEYWORD," $0; domain_count++ }
                        else { print "  - DOMAIN," $0; domain_count++ }
                      }
                      else {
                        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ ASN –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–∞)
                        if (is_valid_asn($0)) {
                          print "  - SRC-IP-ASN," $0; asn_count++;
                        } else {
                          print "  - DOMAIN-SUFFIX," $0; domain_count++;
                        }
                      }
                    }
                  }
                  END {
                    print "# STATS: domains=" domain_count ", ips=" ip_count ", regex=" regex_count ", asn=" asn_count > "/dev/stderr";
                  }
EOF_AWK
                ;;
              
              yaml)
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö YAML —Ñ–∞–π–ª–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π ASN
                curl -sfL "$url" | 
                awk -v safe_name="$safe_name" -f /dev/stdin <<'EOF_AWK'
                  BEGIN { 
                    print "payload:" 
                    domain_count = 0
                    ip_count = 0
                    asn_count = 0
                  }
                  function clean_value(val) {
                    gsub(/^[ \t"]+|[ \t"]+$/, "", val);
                    gsub(/^\'|\'$/, "", val);
                    gsub(/^"|"$/, "", val);
                    return val;
                  }
                  function is_valid_asn(asn) {
                    if (asn ~ /^[0-9]+$/) {
                      num = asn + 0;
                      return (num >= 1 && num <= 4294967295);
                    }
                    return 0;
                  }
                  function is_ipv4(addr) {
                    if (addr ~ /^([0-9]{1,3}\\.){3}[0-9]{1,3}(\/[0-9]{1,2})?$/) {
                      split(addr, parts, "/"); if (parts[2] == "") parts[2] = 32;
                      if (parts[2] < 0 || parts[2] > 32) return 0;
                      split(parts[1], octets, "."); if (length(octets) != 4) return 0;
                      for (i=1; i<=4; i++) if (octets[i] < 0 || octets[i] > 255) return 0;
                      return 1;
                    }
                    return 0;
                  }
                  function is_ipv6(addr) {
                    if (addr ~ /^([0-9a-fA-F:]+)(\/[0-9]{1,3})?$/) {
                      split(addr, parts, "/"); if (parts[2] == "") parts[2] = 128;
                      if (parts[2] < 0 || parts[2] > 128) return 0;
                      return 1;
                    }
                    return 0;
                  }
                  /- (DOMAIN|IP-CIDR|SRC-IP-ASN|GEOIP)/ && !/GEOIP,category-/ {
                    gsub(/^[ \t]+|[ \t]+$/, "", $0);
                    gsub(/^- /, "", $0);
                    split($0, parts, ",");
                    
                    rule_type = clean_value(parts[1]);
                    value = (length(parts) >= 2) ? clean_value(parts[2]) : "";
                    
                    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º GEOIP –ø—Ä–∞–≤–∏–ª–∞
                    if (rule_type ~ /^GEOIP/) next;
                    
                    # –û–±—Ä–∞–±–æ—Ç–∫–∞ SRC-IP-ASN –ø—Ä–∞–≤–∏–ª
                    if (rule_type ~ /SRC-IP-ASN|ASN/) {
                      if (is_valid_asn(value)) {
                        print "  - SRC-IP-ASN," value;
                        asn_count++;
                      }
                      next;
                    }
                    
                    # –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –¥–æ–º–µ–Ω–æ–≤ –∏ IP
                    if (rule_type ~ /DOMAIN/) {
                      if (value ~ /\*/) {
                        if (value ~ /^\*/) { 
                          gsub(/^\*\./, "", value); 
                          print "  - DOMAIN-SUFFIX," value; domain_count++;
                        }
                        else if (value ~ /\*$/) { 
                          gsub(/\*$/, "", value); 
                          print "  - DOMAIN-KEYWORD," value; domain_count++;
                        }
                        else { 
                          print "  - DOMAIN," value; domain_count++; 
                        }
                      } else {
                        gsub(/^(\.)?/, "", value);
                        print "  - DOMAIN-SUFFIX," value; domain_count++;
                      }
                    }
                    else if (rule_type ~ /IP-CIDR/) {
                      if (is_ipv4(value)) {
                        if (value !~ /\//) value = value "/32";
                        print "  - IP-CIDR," value ",no-resolve"; ip_count++;
                      }
                      else if (is_ipv6(value)) {
                        if (value !~ /\//) value = value "/128";
                        print "  - IP-CIDR6," value ",no-resolve"; ip_count++;
                      }
                    }
                  }
                  END {
                    print "# STATS: domains=" domain_count ", ips=" ip_count ", asn=" asn_count > "/dev/stderr";
                  }
EOF_AWK
                ;;
              
              *)
                echo "‚ùå Unsupported type: $type for $url"
                exit 1
                ;;
            esac > "output/${safe_name}.yaml"
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è
            if [ ! -s "output/${safe_name}.yaml" ]; then
              echo "‚ùå EMPTY FILE: $safe_name.yaml from $url"
              exit 1
            fi
            
            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            domains=$(grep -c "DOMAIN-" "output/${safe_name}.yaml" 2>/dev/null || echo 0)
            ips=$(grep -c "IP-CIDR" "output/${safe_name}.yaml" 2>/dev/null || echo 0)
            regex=$(grep -c "DOMAIN-REGEX" "output/${safe_name}.yaml" 2>/dev/null || echo 0)
            asn=$(grep -c "SRC-IP-ASN" "output/${safe_name}.yaml" 2>/dev/null || echo 0)
            total=$((domains + ips + regex + asn))
            
            echo "‚úÖ Created $safe_name.yaml ($total rules: $domainsD/$ipsI/$regexR/$asnA)"
            
            # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —Ä–µ–ª–∏–∑–∞
            file_size=$(numfmt --to=iec-i --suffix=B --format="%.1f" $(stat -c%s "output/${safe_name}.yaml") 2>/dev/null || echo "unknown size")
            file_list+="- $safe_name.yaml ($file_size, $total rules | $domainsD/$ipsI/$regexR/$asnA | src: $type)\n"
          done
          
          echo "files_list<<EOF" >> $GITHUB_ENV
          echo -e "$file_list" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: üè∑Ô∏è Generate release tag
        id: tag
        run: echo "RELEASE_TAG=v$(date +'%Y%m%d%H')" >> $GITHUB_ENV

      - name: üì§ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "Clash Rules $(date +'%Y-%m-%d %H:%M')"
          body: |
            üåê –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä –ø—Ä–∞–≤–∏–ª –¥–ª—è Clash —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π SRC-IP-ASN
            ‚è∞ –û–±–Ω–æ–≤–ª–µ–Ω–æ: $(date +'%Y-%m-%d %H:%M UTC')
            
            **üì¶ –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
            ${{ env.files_list }}
            
            **‚öôÔ∏è –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –ø—Ä–∞–≤–∏–ª:**
            - **–î–æ–º–µ–Ω—ã:** `DOMAIN`, `DOMAIN-SUFFIX`, `DOMAIN-KEYWORD`, `DOMAIN-REGEX`
            - **IP-–∞–¥—Ä–µ—Å–∞:** `IP-CIDR`, `IP-CIDR6` (—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º no-resolve)
            - **ASN –º–∞—Ä—à—Ä—É—Ç—ã:** `SRC-IP-ASN` (–≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–æ–≤ ASN)
            - **–ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã–µ:** `GEOIP`, `geosite:`
            
            **üîÑ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ASN:**
            - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤: `src-ip-asn:`, `src-asn:`, `asn:`
            - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è ASN (–¥–∏–∞–ø–∞–∑–æ–Ω 1-4294967295)
            - –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç Clash: `SRC-IP-ASN,12345`
            - –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö ASN –Ω–æ–º–µ—Ä–æ–≤
            
            **üí° –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ASN –ø—Ä–∞–≤–∏–ª –≤ Clash:**
            ```yaml
            rules:
              - SRC-IP-ASN,12345,DIRECT  # –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è ASN 12345
              - SRC-IP-ASN,67890,PROXY   # –ü—Ä–æ–∫—Å–∏ –¥–ª—è ASN 67890
            ```
            
            **üîß –ü—Ä–∏–º–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞:**
            ```yaml
            rule-providers:
              asn-rules:
                type: http
                url: "https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_TAG }}/asn-rules.yaml"
                path: ./ruleset/asn-rules.yaml
                interval: 21600
            ```
          files: |
            output/*.yaml
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üóëÔ∏è Cleanup
        if: always()
        run: rm -rf output/

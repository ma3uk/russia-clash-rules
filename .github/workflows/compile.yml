name: Convert Domain Lists to Clash YAML (V2Ray + IP Support)

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  process-domains:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: üöÄ Checkout repository
        uses: actions/checkout@v4

      - name: üìÇ Create output directory
        run: mkdir -p output

      - name: üîç Process domain lists with IP/CIDR support
        id: process_files
        run: |
          declare -A sources=(
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/antifilter-download-community.txt"]="antifilter-community"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/antifilter-download.txt"]="antifilter"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/category-ads-all.txt"]="ads-all"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/discord.txt"]="discord"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/google.txt"]="google"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/refilter.txt"]="refilter"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/ru-blocked-all.txt"]="ru-blocked-all"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/ru-blocked.txt"]="ru-blocked"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/win-extra.txt"]="win-extra"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/win-spy.txt"]="win-spy"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/win-update.txt"]="win-update"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/youtube.txt"]="youtube"
            ["https://raw.githubusercontent.com/dartraiden/no-russia-hosts/refs/heads/master/hosts.txt"]="blocked-from-outside"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/akamai.txt"]="akamai"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/amazon.txt"]="amazon"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/autodesk.txt"]="autodesk"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/azure.txt"]="azure"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/cloudflare.txt"]="cloudflare"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/gemini.txt"]="gemini"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/hetzner.txt"]="hetzner"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/intel.txt"]="intel"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/riot-games.txt"]="riot-games"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/roscomandzor-iplist.txt"]="roscomandzor-iplist"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/telegram.txt"]="telegram"
            ["https://raw.githubusercontent.com/ma3uk/russia-clash-rules/refs/heads/main/custom_lists/twitter.txt"]="twitter"
          )
          
          file_list=""
          
          for url in "${!sources[@]}"; do
            custom_name="${sources[$url]}"
            safe_name=$(echo "$custom_name" | 
                        tr '[:upper:]' '[:lower:]' | 
                        sed 's/[^a-z0-9._-]/_/g' |
                        sed 's/__/_/g' |
                        sed 's/^_//;s/_$//')
            
            echo "üì• Processing $url ‚Üí $safe_name.yaml"
            
            curl -sfL "$url" | 
            grep -vE '^#|^$|://' | 
            sed -E '/^[[:space:]]*$/d' | 
            awk -v name="$safe_name" '
              BEGIN { print "payload:" }
              
              {
                gsub(/^[ \t]+|[ \t]+$/, "", $0);
                if ($0 == "") next;
                
                # –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º V2Ray-–ø—Ä–µ—Ñ–∏–∫—Å—ã
                if ($0 ~ /^domain:/) {
                  domain = substr($0, 8);
                  processDomain(domain);
                  next;
                }
                else if ($0 ~ /^full:/) {
                  domain = substr($0, 6);
                  print "  - DOMAIN," domain;
                  next;
                }
                else if ($0 ~ /^regexp:/) {
                  regex = substr($0, 9);
                  gsub(/\\/, "\\\\", regex);
                  print "  - DOMAIN-REGEX," regex;
                  next;
                }
                else if ($0 ~ /^geosite:/) {
                  next;
                }
                
                # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º IP –î–û –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–º–µ–Ω–æ–≤
                if (isCIDRv4($0)) {
                  print "  - IP-CIDR," $0;
                  next;
                }
                else if (isCIDRv6($0)) {
                  print "  - IP-CIDR6," $0;
                  next;
                }
                else if (isIPv4($0)) {
                  print "  - IP-CIDR," $0 "/32";
                  next;
                }
                else if (isIPv6($0)) {
                  print "  - IP-CIDR6," $0 "/128";
                  next;
                }
                
                # –ï—Å–ª–∏ –Ω–µ IP - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –¥–æ–º–µ–Ω
                processDomain($0);
              }
              
              function isIPv4(addr) {
                if (addr ~ /^([0-9]{1,3}\.){3}[0-9]{1,3}$/) {
                  split(addr, octets, ".");
                  if (length(octets) != 4) return 0;
                  for (i=1; i<=4; i++) {
                    if (octets[i] !~ /^[0-9]+$/ || octets[i] < 0 || octets[i] > 255) 
                      return 0;
                  }
                  return 1;
                }
                return 0;
              }
              
              function isIPv6(addr) {
                # –ü—Ä–æ—Å—Ç–∞—è, –Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ IPv6
                if (addr ~ /:/ && addr !~ /\./ && addr ~ /^[0-9a-fA-F:]+$/) {
                  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ö–æ—Ç—è –±—ã –¥–≤—É—Ö –¥–≤–æ–µ—Ç–æ—á–∏–π (–º–∏–Ω–∏–º—É–º –¥–ª—è IPv6)
                  if (gsub(/:/, "&", addr) < 2) return 0;
                  return 1;
                }
                return 0;
              }
              
              function isCIDRv4(cidr) {
                if (cidr ~ /^([0-9]{1,3}\.){3}[0-9]{1,3}\/[0-9]{1,2}$/) {
                  split(cidr, parts, "/");
                  ip = parts[1];
                  prefix = parts[2] + 0;  # –Ø–≤–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —á–∏—Å–ª–æ
                  
                  if (!isIPv4(ip)) return 0;
                  if (prefix < 0 || prefix > 32) return 0;
                  return 1;
                }
                return 0;
              }
              
              function isCIDRv6(cidr) {
                if (cidr ~ /^[0-9a-fA-F:]+\/[0-9]{1,3}$/) {
                  split(cidr, parts, "/");
                  ip = parts[1];
                  prefix = parts[2] + 0;  # –Ø–≤–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —á–∏—Å–ª–æ
                  
                  if (!isIPv6(ip)) return 0;
                  if (prefix < 0 || prefix > 128) return 0;
                  return 1;
                }
                return 0;
              }
              
              function processDomain(domain) {
                if (domain ~ /^\*/) {
                  gsub(/^\*\./, "", domain);
                  print "  - DOMAIN-SUFFIX," domain;
                }
                else if (domain ~ /\*$/) {
                  gsub(/\*$/, "", domain);
                  print "  - DOMAIN-KEYWORD," domain;
                }
                else {
                  print "  - DOMAIN-SUFFIX," domain;
                }
              }
            ' > "output/${safe_name}.yaml"
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è
            if [ ! -s "output/${safe_name}.yaml" ]; then
              echo "‚ùå EMPTY FILE: $safe_name.yaml from $url"
              exit 1
            fi
            
            rules_count=$(grep -c '^  - ' "output/${safe_name}.yaml" || true)
            echo "‚úÖ Created $safe_name.yaml ($rules_count rules)"
            
            file_size=$(numfmt --to=iec-i --suffix=B --format="%.1f" $(stat -c%s "output/${safe_name}.yaml") 2>/dev/null || echo "unknown size")
            file_list+="- $safe_name.yaml ($file_size, $rules_count rules)\n"
          done
          
          echo "files_list<<EOF" >> $GITHUB_ENV
          echo -e "$file_list" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: üè∑Ô∏è Generate release tag
        run: echo "RELEASE_TAG=v$(date +'%Y%m%d%H%M%S')" >> $GITHUB_ENV

      - name: üì§ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "Clash Rules with IP Support"
          body: |
            **Generated files (with IP/CIDR support):**
            ${{ env.files_list }}
          files: output/*.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üóëÔ∏è Cleanup
        if: always()
        run: rm -rf output/

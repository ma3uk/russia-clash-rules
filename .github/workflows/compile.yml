name: Convert Domain Lists to Clash YAML (Full V2Ray Support)

on:
  schedule:
    - cron: "0 */6 * * *"  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
  workflow_dispatch:       # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ UI

jobs:
  process-domains:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ª–∏–∑–æ–≤

    steps:
      - name: üöÄ Checkout repository
        uses: actions/checkout@v4

      - name: üìÇ Create output directory
        run: mkdir -p output

      - name: üîç Process domain lists with full V2Ray conversion
        id: process_files
        run: |
          # –ú–ê–°–°–ò–í –ò–°–¢–û–ß–ù–ò–ö–û–í: URL -> –ñ–µ–ª–∞–µ–º–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
          declare -A sources=(
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/antifilter-download-community.txt"]="antifilter-community"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/antifilter-download.txt"]="antifilter"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/category-ads-all.txt"]="ads-all"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/discord.txt"]="discord"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/google.txt"]="google"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/refilter.txt"]="refilter"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/ru-blocked-all.txt"]="ru-blocked-all"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/ru-blocked.txt"]="ru-blocked"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/win-extra.txt"]="win-extra"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/win-spy.txt"]="win-spy"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/win-update.txt"]="win-update"
            ["https://github.com/runetfreedom/russia-blocked-geosite/releases/latest/download/youtube.txt"]="youtube"
            ["https://raw.githubusercontent.com/dartraiden/no-russia-hosts/refs/heads/master/hosts.txt"]="blocked-from-outside"
          )
          
          file_list=""
          
          for url in "${!sources[@]}"; do
            custom_name="${sources[$url]}"
            safe_name=$(echo "$custom_name" | 
                        tr '[:upper:]' '[:lower:]' | 
                        sed 's/[^a-z0-9._-]/_/g' |
                        sed 's/__/_/g' |
                        sed 's/^_//;s/_$//')
            
            echo "üì• Processing $url ‚Üí $safe_name.yaml"
            
            # –°–∫–∞—á–∏–≤–∞–µ–º –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å –ø–æ–ª–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π V2Ray
            curl -sfL "$url" | 
            grep -v '^#\|^$\|://' |          # –£–¥–∞–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
            sed -E '/^[[:space:]]*$/d' |     # –£–¥–∞–ª—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
            awk -v name="$safe_name" '
              BEGIN { 
                print "payload:" 
                domain_count = 0
                ip_count = 0
                regex_count = 0
              }
              
              function is_ipv4(addr) {
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º IPv4 –∞–¥—Ä–µ—Å –∏–ª–∏ CIDR
                if (addr ~ /^([0-9]{1,3}\\.){3}[0-9]{1,3}(\/[0-9]{1,2})?$/) {
                  split(addr, parts, "/")
                  if (parts[2] == "") parts[2] = 32
                  if (parts[2] < 0 || parts[2] > 32) return 0
                  
                  split(parts[1], octets, ".")
                  if (length(octets) != 4) return 0
                  for (i=1; i<=4; i++) {
                    if (octets[i] < 0 || octets[i] > 255) return 0
                  }
                  return 1
                }
                return 0
              }
              
              function is_ipv6(addr) {
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º IPv6 –∞–¥—Ä–µ—Å –∏–ª–∏ CIDR
                if (addr ~ /^([0-9a-fA-F:]+)(\/[0-9]{1,3})?$/) {
                  split(addr, parts, "/")
                  if (parts[2] == "") parts[2] = 128
                  if (parts[2] < 0 || parts[2] > 128) return 0
                  return 1
                }
                return 0
              }
              
              {
                gsub(/^[ \t]+|[ \t]+$/, "", $0);  # –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –ø–æ –∫—Ä–∞—è–º
                
                # –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º geosite: –ø—Ä–∞–≤–∏–ª–∞
                if ($0 ~ /^geosite:/) {
                  next;
                }
                
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ V2Ray –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤
                if ($0 ~ /^domain:/) {
                  domain = substr($0, 8);
                  gsub(/^[ \t]+|[ \t]+$/, "", domain);
                  
                  if (domain ~ /\*/) {
                    if (domain ~ /^\*/) {
                      gsub(/^\*\./, "", domain);
                      print "  - DOMAIN-SUFFIX," domain;
                      domain_count++;
                    } else if (domain ~ /\*$/) {
                      gsub(/\*$/, "", domain);
                      print "  - DOMAIN-KEYWORD," domain;
                      domain_count++;
                    } else {
                      print "  - DOMAIN," domain;
                      domain_count++;
                    }
                  } else {
                    print "  - DOMAIN-SUFFIX," domain;
                    domain_count++;
                  }
                }
                else if ($0 ~ /^full:/) {
                  domain = substr($0, 6);
                  gsub(/^[ \t]+|[ \t]+$/, "", domain);
                  print "  - DOMAIN," domain;
                  domain_count++;
                }
                else if ($0 ~ /^regexp:/) {
                  regex = substr($0, 9);
                  gsub(/^[ \t]+|[ \t]+$/, "", regex);
                  gsub(/\\/, "\\\\", regex);  # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω—ã–µ —Å–ª–µ—à–∏
                  print "  - DOMAIN-REGEX," regex;
                  regex_count++;
                }
                else if ($0 ~ /^ipcidr:/) {
                  ip_range = substr($0, 9);
                  gsub(/^[ \t]+|[ \t]+$/, "", ip_range);
                  
                  if (is_ipv4(ip_range)) {
                    if (ip_range !~ /\//) ip_range = ip_range "/32";
                    print "  - IP-CIDR," ip_range ",no-resolve";
                    ip_count++;
                  }
                  else if (is_ipv6(ip_range)) {
                    if (ip_range !~ /\//) ip_range = ip_range "/128";
                    print "  - IP-CIDR6," ip_range ",no-resolve";
                    ip_count++;
                  }
                  else {
                    # –ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                    next;
                  }
                }
                else {
                  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –¥–ª—è —Å—Ç—Ä–æ–∫ –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞
                  if (is_ipv4($0)) {
                    ip = $0;
                    if (ip !~ /\//) ip = ip "/32";
                    print "  - IP-CIDR," ip ",no-resolve";
                    ip_count++;
                  }
                  else if (is_ipv6($0)) {
                    ip = $0;
                    if (ip !~ /\//) ip = ip "/128";
                    print "  - IP-CIDR6," ip ",no-resolve";
                    ip_count++;
                  }
                  else if ($0 ~ /^regexp:/) {
                    # –ù–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –ø—Ä–µ—Ñ–∏–∫—Å –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ —Å—Ç—Ä–æ–∫–∏
                    regex = substr($0, index($0, ":") + 1);
                    gsub(/^[ \t]+|[ \t]+$/, "", regex);
                    gsub(/\\/, "\\\\", regex);
                    print "  - DOMAIN-REGEX," regex;
                    regex_count++;
                  }
                  else if ($0 ~ /\*/) {
                    # –û–±—Ä–∞–±–æ—Ç–∫–∞ wildcard –¥–æ–º–µ–Ω–æ–≤ –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞
                    if ($0 ~ /^\*/) {
                      gsub(/^\*\./, "", $0);
                      print "  - DOMAIN-SUFFIX," $0;
                      domain_count++;
                    } else if ($0 ~ /\*$/) {
                      gsub(/\*$/, "", $0);
                      print "  - DOMAIN-KEYWORD," $0;
                      domain_count++;
                    } else {
                      print "  - DOMAIN," $0;
                      domain_count++;
                    }
                  } else {
                    # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –¥–æ–º–µ–Ω—ã
                    print "  - DOMAIN-SUFFIX," $0;
                    domain_count++;
                  }
                }
              }
              
              END {
                print "# STATS: domains=" domain_count ", ips=" ip_count ", regex=" regex_count > "/dev/stderr";
              }
            ' > "output/${safe_name}.yaml"
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è
            if [ ! -s "output/${safe_name}.yaml" ]; then
              echo "‚ùå EMPTY FILE: $safe_name.yaml from $url"
              exit 1
            fi
            
            # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            domains=$(grep -c "DOMAIN-" "output/${safe_name}.yaml" 2>/dev/null || echo 0)
            ips=$(grep -c "IP-CIDR" "output/${safe_name}.yaml" 2>/dev/null || echo 0)
            regex=$(grep -c "DOMAIN-REGEX" "output/${safe_name}.yaml" 2>/dev/null || echo 0)
            total=$((domains + ips + regex))
            
            echo "‚úÖ Created $safe_name.yaml ($total rules: $domains domains, $ips IPs, $regex regex)"
            
            # –°–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è —Ä–µ–ª–∏–∑–∞
            file_size=$(numfmt --to=iec-i --suffix=B --format="%.1f" $(stat -c%s "output/${safe_name}.yaml") 2>/dev/null || echo "unknown size")
            file_list+="- $safe_name.yaml ($file_size, $total rules: $domainsD/$ipsI/$regexR)\n"
          done
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è —à–∞–≥–∞ —Ä–µ–ª–∏–∑–∞
          echo "files_list<<EOF" >> $GITHUB_ENV
          echo -e "$file_list" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: üè∑Ô∏è Generate release tag
        id: tag
        run: echo "RELEASE_TAG=v$(date +'%Y%m%d%H')" >> $GITHUB_ENV

      - name: üì§ Create GitHub Release with Individual Files
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "Clash Rules $(date +'%Y-%m-%d %H:%M')"
          body: |
            ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è Clash —Å –ø–æ–ª–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π V2Ray-—Ñ–æ—Ä–º–∞—Ç–æ–≤.
            ‚è∞ –û–±–Ω–æ–≤–ª–µ–Ω–æ: $(date +'%Y-%m-%d %H:%M UTC')
            
            **–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã:**
            ${{ env.files_list }}
            
            üîß **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø—Ä–µ—Ñ–∏–∫—Å—ã V2Ray:**
            - `domain:` ‚Üí `DOMAIN-SUFFIX`/`DOMAIN-KEYWORD`/`DOMAIN`
            - `full:` ‚Üí `DOMAIN`
            - `regexp:` ‚Üí `DOMAIN-REGEX` (—Å –¥–≤–æ–π–Ω—ã–º —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º `\`)
            - `ipcidr:` ‚Üí `IP-CIDR`/`IP-CIDR6` (—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –≤–µ—Ä—Å–∏–∏ IP)
            - `geosite:` ‚Üí **–ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—è–µ—Ç—Å—è** (–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ Clash –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ)
            
            üåê **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ IP-–∞–¥—Ä–µ—Å–æ–≤:**
            - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ IPv4/IPv6
            - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Å–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (/32 –¥–ª—è IPv4, /128 –¥–ª—è IPv6)
            - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ IP-–∞–¥—Ä–µ—Å–æ–≤ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º
            
            üí° **–ü—Ä–∏–º–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ Clash:**
            ```yaml
            rule-providers:
              anti-ads:
                type: http
                url: "https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_TAG }}/anti-ads.yaml"
                path: ./ruleset/anti-ads.yaml
                interval: 21600  # 6 —á–∞—Å–æ–≤
              
              ip-blocks:
                type: http
                url: "https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_TAG }}/ip-rules.yaml"
                path: ./ruleset/ip-blocks.yaml
                interval: 21600
            ```
          files: |
            output/*.yaml
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üóëÔ∏è Cleanup
        if: always()
        run: rm -rf output/
